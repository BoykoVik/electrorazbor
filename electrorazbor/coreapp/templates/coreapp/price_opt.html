{% load static %}
{% include "layout/head.html" %}
<body>
    <div class="main-wrapper">
        {% include "layout/header.html" %}
        <div class="offcanvas-overlay"></div>
        <div id="offcanvas-mobile-menu" class="offcanvas offcanvas-mobile-menu">
            <button class="offcanvas-close"></button>
            <div class="user-panel">
                <ul>
                    {% include "layout/contactsblock.html" %}
                </ul>
            </div>
            <div class="inner customScroll">
                <div class="offcanvas-menu mb-4">
                    <ul>
                        {% include "layout/menu.html" %}
                    </ul>
                </div>
            </div>
        </div>

        <div class="about-area pt-100px">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <div class="about-wrapper text-center">
                            <div class="about-contant">
                                <h1 class="title">
                                    Оптовый прайс
                                </h1>
                                <p>Мы отправляем оптовый прайс лично каждому, кто готов к сотрудничеству. Заполните форму и наш менеджер свяжется с Вами.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="login-register-area pt-100px pb-100px">
            <div class="container">
                <div class="row">
                    <div class="col-lg-7 col-md-12 ml-auto mr-auto">
                        <div class="login-register-wrapper">
                            <div class="tab-content">
                                <div id="lg1" class="tab-pane active">
                                    <div class="login-form-container">
                                        <div class="login-register-form">
                                            
                                            <form id="priceform" method="post">
                                                {% csrf_token %}
                                                <input id="phone" type="text" name="phone" placeholder="Телефон" />
                                                <div id="phoneError" style="color: red; display: none; font-size: 12px; margin-top: 5px;"></div>
                                                <textarea id="textmessage" style="padding: 0 5px;" placeholder="Оставьте комментарий ..." type="text" name="textmessage"></textarea>
                                                <div class="button-box">
                                                    <p style="padding-bottom: 20px;">Отправляя данные, вы соглашаетесь на обработку персональных данных в соответствии с 
                                                        <a href='{% url 'coreapp:soglasie' %}'>условиями.</a></p>
                                                    <button type="submit"><span>Заказать прайс</span></button>
                                                </div>
                                            </form>
                                            
                                            <!-- Сообщение об успехе (изначально скрыто) -->
                                            <div id="successMessage" style="display: none; color: green; padding: 20px; text-align: center; font-size: 18px;">
                                                Ваш запрос принят, менеджер скоро свяжется с Вами
                                            </div>
                                            
                                            <script>
                                                document.addEventListener('DOMContentLoaded', function() {
                                                    const phoneInput = document.getElementById('phone');
                                                    const phoneError = document.getElementById('phoneError');
                                                    const form = document.getElementById('priceform');
                                                    const successMessage = document.getElementById('successMessage');
                                                
                                                    // Разрешаем ввод только цифр, пробела, +, -, (, )
                                                    phoneInput.addEventListener('input', function(e) {
                                                        let value = e.target.value.replace(/[^\d\s\+\-\(\)]/g, '');
                                                        e.target.value = value;
                                                        phoneError.style.display = 'none';
                                                        phoneInput.style.borderColor = '';
                                                    });
                                                
                                                    // Запрещаем ввод букв и других символов
                                                    phoneInput.addEventListener('keypress', function(e) {
                                                        const allowedChars = /[\d\s\+\-\(\)]/;
                                                        if (!allowedChars.test(e.key)) {
                                                            e.preventDefault();
                                                        }
                                                    });
                                                
                                                    // Валидация при отправке формы
                                                    form.addEventListener('submit', function(event) {
                                                        event.preventDefault();
                                                        
                                                        const phoneValue = phoneInput.value.replace(/\D/g, '');
                                                        
                                                        if (phoneValue.length !== 11) {
                                                            phoneError.style.display = 'block';
                                                            phoneInput.style.borderColor = 'red';
                                                            phoneInput.focus();
                                                            
                                                            if (phoneValue.length === 0) {
                                                                phoneError.textContent = 'Пожалуйста, введите номер телефона';
                                                            } else {
                                                                phoneError.textContent = `Введено ${phoneValue.length} цифр. Нужно 11 цифр.`;
                                                            }
                                                            return false;
                                                        }
                                                        
                                                        // Если валидация прошла успешно - отправляем AJAX
                                                        phoneError.style.display = 'none';
                                                        phoneInput.style.borderColor = 'green';
                                                        
                                                        // Получаем CSRF токен
                                                        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                                                        
                                                        // Отправляем AJAX запрос
                                                        fetch("{% url 'coreapp:order_price' %}", {
                                                            method: 'POST',
                                                            headers: {
                                                                'X-CSRFToken': csrfToken,
                                                                'Content-Type': 'application/x-www-form-urlencoded',
                                                            },
                                                            body: new URLSearchParams({
                                                                'phone': phoneInput.value,
                                                                'textmessage': document.getElementById('textmessage').value,
                                                            })
                                                        })
                                                        .then(response => {
                                                            if (!response.ok) {
                                                                throw new Error('Network response was not ok');
                                                            }
                                                            return response.json();
                                                        })
                                                        .then(data => {
                                                            if (data.success) {
                                                                form.style.display = 'none';
                                                                successMessage.style.display = 'block';
                                                            } else {
                                                                alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                                                            }
                                                        })
                                                        .catch(error => {
                                                            console.error('Ошибка:', error);
                                                            alert('Произошла ошибка при отправке: ' + error.message);
                                                        });
                                                    });
                                                
                                                    // Дополнительная валидация при потере фокуса
                                                    phoneInput.addEventListener('blur', function() {
                                                        const phoneValue = this.value.replace(/\D/g, '');
                                                        if (phoneValue.length > 0 && phoneValue.length !== 11) {
                                                            phoneError.style.display = 'block';
                                                            phoneInput.style.borderColor = 'red';
                                                            phoneError.textContent = `Введено ${phoneValue.length} цифр. Нужно 11 цифр.`;
                                                        }
                                                    });
                                                });
                                                </script>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script src="{% static 'js/inputmask.js'%}"></script>
        {% include "layout/contacts_block.html" %}
        {% include "layout/footer.html" %}
    </div>
    {% include "layout/scripts.html" %}
</body>
</html>